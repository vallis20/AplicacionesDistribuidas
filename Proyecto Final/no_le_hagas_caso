from flask import Flask, render_template, request
import pyodbc

app = Flask(__name__)

# Establecer la conexión a la base de datos SQL Server
conn = pyodbc.connect(
    'DRIVER={SQL Server};'
    'SERVER=tu_servidor;'
    'DATABASE=nombre_de_tu_base_de_datos;'
    'UID=tu_usuario;'
    'PWD=tu_contraseña;'
)

@app.route('/')
def index():
    return render_template('formulario.html')

@app.route('/procesar_factura', methods=['POST'])
def procesar_factura():
    nombre = request.form['nombre']
    metodo_pago = request.form['metodo_pago']
    numT = request.form['numT']
    total_pagar = request.form['total_pagar']

    try:
        cursor = conn.cursor()

        # Obtener el usuario_id basado en el nombre del usuario
        cursor.execute("SELECT usr_id FROM Usuarios WHERE nombre = ?", nombre)
        usuario = cursor.fetchone()

        if usuario:
            usuario_id = usuario['usr_id']

            # Insertar datos en la tabla Facturacion
            sql = "INSERT INTO Facturacion (usuario_id, total_amount, descripcion, tarjeta) VALUES (?, ?, ?, ?)"
            cursor.execute(sql, (usuario_id, total_pagar, 'Pago de suscripción', numT))
            conn.commit()

            return "Datos insertados correctamente"
        else:
            return "El usuario no fue encontrado"
    except Exception as e:
        return f"Error: {str(e)}"


if __name__ == '__main__':
    app.run(debug=True)

raceback (most recent call last):
  File "c:\Users\Home PC\Desktop\proyecto_final\pruebas\app.py", line 7, in <module>
    conn = pyodbc.connect(
           ^^^^^^^^^^^^^^^
pyodbc.InterfaceError: ('IM002', '[IM002] [Microsoft][Administrador de controladores ODBC] No se encuentra el nombre del origen de datos y no se especificó ningún controlador predeterminado (0) (SQLDriverConnect)')

* Serving Flask app 'app'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on http://127.0.0.1:5000
Press CTRL+C to quit
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 217-479-060
